# 第三讲：R、T、四元数、欧拉角

标签（空格分隔）： SLAM

---

 - 向量内积：$a*b$描述b向量在a向量方向上的投影
 

 - 外积：a×b=a^b描述a到b的旋转向量
  - 右手坐标系下四指从a转到b，大拇指指向旋转向量方向，旋转角度决定旋转向量大小
  - 其中^为反对称符号，**a^**为向量**a**的反对称矩阵
 
-----
  向量之间的旋转用旋转向量描述，坐标系之间的**变换**（旋转+平移）用变换矩阵描述
 
 - **欧式变换** 
保证同一个向量在各坐标系下的长度和夹角不会变化。
  -  变换矩阵T=旋转矩阵R+平移向量t
  -  从**a**到**a'**的欧式变换表达：$a'=Ra+t$
  -  **R**为正交矩阵（逆=转置），所以**R<sup>T</sup>**表示一个相反的旋转


----

 - **齐次坐标**
  
 - 三维坐标多次变换之后形式复杂，如两次变换$R_1,t_1(a到b）R_2,t_2（b到c）$

     则有a到c为： $c=R_2(R_1a+t_1)+t_2$

 - 数学技巧：在三维向量末尾加1将其变为齐次坐标。引入是为了将多次欧式变换后的复杂形式简化为线性关系

    **$a'=Ra+t$变为$
\left[
\begin{matrix}
a'\\1
\end{matrix}
\right]
$=$
\left[
\begin{matrix}
R&t\\
0^T&1
\end{matrix}
\right]
$$
\left[
\begin{matrix}
a\\1
\end{matrix}
\right]
$=T$
\left[
\begin{matrix}
a\\1
\end{matrix}
\right]
$**

 - **$c=R_2(R_1a+t_1)+t_2$变为$c=T_2T_1a$(第一个公式是三维坐标，第二个公式都是齐次坐标)**
 
 - 齐次坐标中，$[1,1,1,1]^T$与$[2,2,2,2]^T$表示同一个点，所以同一点坐标不唯一。
    强制最后一项为1，得到唯一的坐标（非齐次坐）：
    $\bar x=[x,y,z,w]^T=[x/w,y/w,z/w,1]^T$
 
 - 默认**$b=Ta$**中为齐次坐标,**$b=Ra$**中为三维坐标，一个等式中默认齐次非齐次转换已经完成了。
 
-----
**旋转向量**

 - R的缺点：
  - 有冗余：旋转只有3个自由度，而R用9个量描述，变换只有6个自由度，而T用16个量描述
  - 有约束：R为SO(3)，要求必须为正交矩阵且行列式为1，T为SE(3)，也有约束，优化时麻烦
  
因此需要更紧凑的方式描述旋转、变换————旋转向量

任意旋转都能用**一个旋转轴n+一个旋转角**表示，**旋转向量方向为旋转轴n方向，长度等于旋转角$\theta$。**这种表示正好三维描述旋转，六维描述变换。

---

```seq
旋转向量->旋转矩阵: 罗德里格斯公式

旋转矩阵->旋转向量: 分别计算轴角n,theta
```

 1. 多德里格斯公式: $R=cos\theta I+(1-cos\theta)nn^T+sin\theta n$^
 2. 转角$\theta=arccos(tr(R)-1/2)$，其中$tr(R)$为矩阵R的迹trace，主对角线上求和
 转轴$n$,有$Rn=n$（旋转轴经旋转之后不变），所以$n$是矩阵$R$特征值1对应的特征向量

----
**欧拉角**

 - 直观描述旋转，把一个旋转分解成3次绕不同轴的旋转。
 - 常用$rpy$角：
 1. 绕Z轴——偏航角yaw
 2. 绕旋转之后的Y轴——俯仰角pitch
 3. 绕旋转之后的X轴——滚转角roll
得到三维向量 $[r,p,y]^T$描述任意旋转

 - 缺点——万象锁问题
pitch为90度时，第一次旋转和第三次旋转将使用同一个轴，使得系统少了一个自由度（3次旋转变成了2次旋转）
所以由于这个奇异性，在SLAM程序、滤波和优化中不用欧拉角表达姿态

---
**四元数**

 - **三维旋转没有不带奇异性的三维向量描述方式**（类似二维中经纬度的奇异性，纬度为±90°时经度无意义）
 - 旋转矩阵$R$有冗余性
   旋转向量$\theta n$和欧拉角$[r,p,y]^T$紧凑但是有奇异性
   四元数$q$既是紧凑的也没有奇异性
 - 四元数是一种扩展的**复数**，有一个实部三个虚部
 $q=q_0+q_1i+q_2j+q_3k$

 向量表示：$q=[s,v],实部s=q_0,虚部v=[q_1,q_2,q_3]^T$
 - 一个虚四元数表示一个空间点，单位四元数表示任意一个旋转
 
----
 **旋转向量与四元数转换**：
  1. 从轴角计算单位四元数：
- 某个旋转绕单位向量$n=[n_x,n_y,n_z]^T$进行角度为$\theta$的旋转，四元数形式：
  $q=[cos {\theta\over2},n_xsin{\theta\over2},n_ysin{\theta\over2},n_zsin{\theta\over2}]^T$
   - 若旋转角度变为$\theta+2\pi$，对应四元数变为﹣$q$，即
   **任意旋转都可以由两个互为相反数的四元数表示**
   - 若$\theta$取0，对应没有任何旋转的实四元数：$q_0=[±1,0,0,0]^T$
  2. 从单位四元数计算轴角：
  $\theta=2$$arccos$$q_0$          
$[n_x,n_y,n_z]^T=[q_1,q_2,q_3]^T/sin{\theta\over2}$

----
**旋转矩阵与四元数转换**

----
**旋转表示**
设一个空间三维点为$p=[x,y,z]^T$
经一个旋转（由轴角$\theta n$确定）之后变为$p'$

- 用$R$表示：$p'=Rp$
- 用$q$表示：
  1. 用一个虚四元数表示$p=[0,x,y,z]=[0,v]$（四元数虚部三个分量对应三个空间中三个轴）
  2. 用四元数表示旋转：$q=[cos{\theta\over2},nsin{\theta\over2}]$
  3. $p'=qpq^{﹣1}$（计算的结果也为一个纯虚四元数）

---
- $T_{cw}$表示世界坐标系到相机坐标系的转换矩阵：$p_c=T_{cw}p_w$
 $T_{wc}$表示相机到世界的转换矩阵（是$T_{cw}$的逆）：$p_w=T_{wc}p_c$
- $T_{wc}和T_{cw}$都可表示相机位姿，$T_{cw}$实践中更常用

- $T_{wc}$更直观：
相机原点在世界坐标系的坐标为：
$p_w=T_{wc}0=t_{wc}$
$t_{wc}$正是$T_{wc}$的平移部分，所以从$T_{wc}$可以直接看出相机在何处，所以更直观

----
**相似、仿射、射影变换**
|变换|自由度
---|
欧式变换|6
相似变换|7（多了一个缩放因子）
仿射变换|12
射影变换|15（方形地砖在相片上变为不规则四方形）

- 真实世界到相机照片的变换是一个射影变换
- 若相机焦距无限远，则为仿射变换